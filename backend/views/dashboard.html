<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - TTPOA</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --nav-bg: rgba(30, 58, 138, 0.92);
      --nav-border: rgba(59, 130, 246, 0.30);
      --card-bg: rgba(30, 58, 138, 0.55);
      --card-border: rgba(59, 130, 246, 0.30);
      --form-bg: rgba(30, 58, 138, 0.50);
      --form-border: rgba(255, 255, 255, 0.20);
      --form-focus: rgba(59, 130, 246, 0.50);
      --text-primary: #e5e7eb;
      --text-muted: rgba(255,255,255,0.55);
      --orange: #f97316;
      --orange-dark: #ea580c;
      --blue: #3b82f6;
      --blue-dark: #2563eb;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 35%, #1e40af 65%, #1e3a8a 100%);
      background-attachment: fixed;
      min-height: 100vh;
      color: var(--text-primary);
      overflow-x: hidden;
    }
    body::before {
      content: ''; position: fixed; inset: 0;
      background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 50px 50px; pointer-events: none; z-index: 0;
    }
    /* Nav */
    .site-nav {
      position: sticky; top: 0; z-index: 50;
      background: var(--nav-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--nav-border); box-shadow: 0 4px 24px rgba(0,0,0,0.25);
    }
    .nav-inner { width: 90%; max-width: 1400px; margin: 0 auto; padding: 0; height: 64px; display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
    .nav-brand { display: flex; align-items: center; gap: 0.75rem; }
    .nav-logo { height: 40px; width: auto; display: block; }
    .nav-brand-text { display: flex; flex-direction: column; }
    .nav-brand-title { font-size: 1rem; font-weight: 700; color: white; line-height: 1.2; }
    .nav-brand-sub { font-size: 0.7rem; font-weight: 600; color: var(--orange); }
    .nav-right { display: flex; align-items: center; gap: 1rem; }
    .nav-user { font-size: 0.8rem; color: rgba(255,255,255,0.75); }
    .nav-user strong { color: white; font-weight: 600; }
    .btn-nav-link { padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.8rem; font-weight: 600; border: none; cursor: pointer; font-family: inherit; transition: all 0.2s; text-decoration: none; display: inline-block; }
    .btn-visit { background: rgba(255,255,255,0.12); color: rgba(255,255,255,0.90); border: 1px solid rgba(255,255,255,0.15); }
    .btn-visit:hover { background: rgba(255,255,255,0.20); color: white; }
    .btn-logout { background: rgba(239,68,68,0.15); color: #fca5a5; border: 1px solid rgba(239,68,68,0.25); }
    .btn-logout:hover { background: rgba(239,68,68,0.28); color: #fecaca; }
    /* Main */
    .main-wrap { width: 90%; max-width: 1400px; margin: 0 auto; padding: 1.5rem 0; position: relative; z-index: 1; }
    /* Tabs */
    .tab-bar { background: var(--nav-bg); backdrop-filter: blur(12px); border: 1px solid var(--nav-border); border-radius: 1rem; padding: 0.625rem; display: flex; flex-wrap: wrap; gap: 0.375rem; margin-bottom: 1.75rem; }
    .tab-btn { padding: 0.625rem 1.25rem; border-radius: 0.625rem; border: none; cursor: pointer; font-family: inherit; font-size: 0.875rem; font-weight: 600; transition: all 0.25s; }
    .tab-btn.active { background: linear-gradient(135deg, var(--orange), var(--orange-dark)); color: white; box-shadow: 0 4px 12px rgba(249,115,22,0.35); }
    .tab-btn.inactive { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.70); }
    .tab-btn.inactive:hover { background: rgba(255,255,255,0.14); color: white; }
    /* Cards */
    .g-card { background: var(--card-bg); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid var(--card-border); border-radius: 1rem; box-shadow: 0 8px 32px rgba(0,0,0,0.15); }
    .g-card-p { padding: 1.25rem; }
    .g-card-row { padding: 1rem 1.25rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    /* Section */
    .section-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; flex-wrap: wrap; gap: 0.75rem; }
    .section-title { font-size: 1.375rem; font-weight: 700; color: white; }
    .section-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.125rem; }
    /* Buttons */
    .btn-primary { padding: 0.625rem 1.25rem; border-radius: 0.625rem; border: none; cursor: pointer; background: linear-gradient(135deg, var(--orange), var(--orange-dark)); color: white; font-family: inherit; font-size: 0.875rem; font-weight: 700; display: inline-flex; align-items: center; gap: 0.5rem; box-shadow: 0 6px 16px rgba(249,115,22,0.30); transition: all 0.25s; }
    .btn-primary:hover { background: linear-gradient(135deg, var(--orange-dark), #c2410c); transform: translateY(-1px); box-shadow: 0 8px 20px rgba(249,115,22,0.40); }
    .btn-edit { padding: 0.375rem 0.875rem; border-radius: 0.5rem; border: none; cursor: pointer; font-family: inherit; font-size: 0.75rem; font-weight: 600; background: rgba(59,130,246,0.18); color: #93c5fd; transition: all 0.2s; }
    .btn-edit:hover { background: rgba(59,130,246,0.30); color: #bfdbfe; }
    .btn-gallery { padding: 0.375rem 0.875rem; border-radius: 0.5rem; border: none; cursor: pointer; font-family: inherit; font-size: 0.75rem; font-weight: 600; background: rgba(168,85,247,0.18); color: #c4b5fd; transition: all 0.2s; }
    .btn-gallery:hover { background: rgba(168,85,247,0.30); color: #ddd6fe; }
    .btn-delete { padding: 0.375rem 0.875rem; border-radius: 0.5rem; border: none; cursor: pointer; font-family: inherit; font-size: 0.75rem; font-weight: 600; background: rgba(239,68,68,0.15); color: #fca5a5; transition: all 0.2s; }
    .btn-delete:hover { background: rgba(239,68,68,0.28); color: #fecaca; }
    .btn-activate { padding: 0.375rem 0.875rem; border-radius: 0.5rem; border: none; cursor: pointer; font-family: inherit; font-size: 0.75rem; font-weight: 600; background: rgba(34,197,94,0.15); color: #86efac; transition: all 0.2s; }
    .btn-activate:hover { background: rgba(34,197,94,0.28); color: #bbf7d0; }
    .btn-deactivate { padding: 0.375rem 0.875rem; border-radius: 0.5rem; border: none; cursor: pointer; font-family: inherit; font-size: 0.75rem; font-weight: 600; background: rgba(234,179,8,0.15); color: #fde047; transition: all 0.2s; }
    .btn-deactivate:hover { background: rgba(234,179,8,0.28); color: #fef08a; }
    .btn-cancel { padding: 0.625rem 1.25rem; border-radius: 0.625rem; border: none; cursor: pointer; font-family: inherit; font-size: 0.875rem; background: rgba(255,255,255,0.10); color: rgba(255,255,255,0.80); transition: all 0.2s; }
    .btn-cancel:hover { background: rgba(255,255,255,0.18); color: white; }
    /* Badges */
    .badge { display: inline-flex; align-items: center; padding: 0.2rem 0.625rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.05em; }
    .badge-upcoming { background: rgba(59,130,246,0.20); color: #93c5fd; border: 1px solid rgba(59,130,246,0.30); }
    .badge-ongoing { background: rgba(34,197,94,0.20); color: #86efac; border: 1px solid rgba(34,197,94,0.30); }
    .badge-recent { background: rgba(148,163,184,0.20); color: #cbd5e1; border: 1px solid rgba(148,163,184,0.30); }
    .badge-active { background: rgba(34,197,94,0.20); color: #86efac; border: 1px solid rgba(34,197,94,0.30); }
    .badge-inactive { background: rgba(148,163,184,0.18); color: #94a3b8; border: 1px solid rgba(148,163,184,0.25); }
    .badge-orange { background: rgba(249,115,22,0.18); color: #fdba74; border: 1px solid rgba(249,115,22,0.28); }
    .dot-active { width: 8px; height: 8px; border-radius: 50%; background: #4ade80; flex-shrink: 0; }
    .dot-inactive { width: 8px; height: 8px; border-radius: 50%; background: #64748b; flex-shrink: 0; }
    /* Forms */
    .f-label { display: block; font-size: 0.78rem; font-weight: 500; color: rgba(255,255,255,0.65); margin-bottom: 0.4rem; letter-spacing: 0.04em; text-transform: uppercase; }
    .f-input, .f-textarea, .f-select { width: 100%; padding: 0.75rem 1rem; background: var(--form-bg); border: 2px solid var(--form-border); border-radius: 0.625rem; color: white; font-size: 0.9rem; font-family: inherit; outline: none; transition: border-color 0.25s, box-shadow 0.25s; }
    .f-input::placeholder, .f-textarea::placeholder { color: rgba(255,255,255,0.38); }
    .f-input:focus, .f-textarea:focus, .f-select:focus { border-color: var(--form-focus); box-shadow: 0 0 0 3px rgba(59,130,246,0.20); }
    .f-textarea { resize: vertical; }
    .f-select { color-scheme: dark; }
    .f-select option { background: #1e3a8a; }
    .f-file { width: 100%; padding: 0.625rem 1rem; background: var(--form-bg); border: 2px solid var(--form-border); border-radius: 0.625rem; color: rgba(255,255,255,0.75); font-size: 0.875rem; font-family: inherit; outline: none; cursor: pointer; }
    .f-file::-webkit-file-upload-button { background: rgba(249,115,22,0.20); color: #fdba74; border: none; padding: 0.25rem 0.875rem; border-radius: 0.375rem; cursor: pointer; margin-right: 0.75rem; font-family: inherit; font-size: 0.8rem; font-weight: 600; transition: background 0.2s; }
    .f-file::-webkit-file-upload-button:hover { background: rgba(249,115,22,0.35); }
    .f-checkbox { appearance: none; width: 18px; height: 18px; border: 2px solid var(--form-border); border-radius: 4px; background: var(--form-bg); cursor: pointer; flex-shrink: 0; transition: all 0.2s; vertical-align: middle; }
    .f-checkbox:checked { background: var(--orange); border-color: var(--orange); }
    .f-group { margin-bottom: 1rem; }
    .f-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 640px) { .f-row { grid-template-columns: 1fr; } }
    /* Modals */
    .modal-overlay { position: fixed; inset: 0; z-index: 60; background: rgba(0,0,0,0.65); backdrop-filter: blur(6px); display: flex; align-items: flex-start; justify-content: center; padding: 2rem 1rem; overflow-y: auto; }
    .modal-box { background: var(--nav-bg); border: 1px solid var(--nav-border); border-radius: 1.25rem; padding: 1.75rem; width: 100%; box-shadow: 0 24px 60px rgba(0,0,0,0.50); margin: auto; position: relative; }
    .modal-title { font-size: 1.125rem; font-weight: 700; color: white; margin-bottom: 1.25rem; padding-bottom: 0.875rem; border-bottom: 1px solid var(--nav-border); display: flex; align-items: center; justify-content: space-between; }
    .modal-close { background: none; border: none; color: rgba(255,255,255,0.50); cursor: pointer; font-size: 1.25rem; line-height: 1; transition: color 0.2s; }
    .modal-close:hover { color: white; }
    .modal-footer { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.25rem; padding-top: 1rem; border-top: 1px solid var(--nav-border); }
    /* Empty state */
    .empty-state { text-align: center; padding: 3rem 2rem; color: var(--text-muted); }
    .empty-state-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
    .empty-state p { font-size: 0.9rem; }
    /* Toasts */
    #toastContainer { position: fixed; top: 1.25rem; right: 1.25rem; z-index: 99; display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none; }
    .toast { padding: 0.875rem 1.25rem; border-radius: 0.75rem; font-size: 0.875rem; font-weight: 600; color: white; max-width: 320px; pointer-events: all; box-shadow: 0 8px 24px rgba(0,0,0,0.30); backdrop-filter: blur(12px); border-left: 3px solid transparent; animation: toastIn 0.3s cubic-bezier(0.4,0,0.2,1); }
    .toast-success { background: rgba(30,58,138,0.95); border-color: #4ade80; }
    .toast-error { background: rgba(30,58,138,0.95); border-color: #f87171; }
    .toast-info { background: rgba(30,58,138,0.95); border-color: var(--blue); }
    @keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    /* Misc */
    .img-preview { width: 100px; height: 70px; object-fit: cover; border-radius: 0.5rem; border: 1px solid var(--card-border); margin-top: 0.5rem; }
    .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.625rem; }
    .gallery-item { position: relative; }
    .gallery-item img { width: 100%; height: 80px; object-fit: cover; border-radius: 0.5rem; border: 1px solid var(--card-border); display: block; }
    .gallery-del { position: absolute; top: 4px; right: 4px; width: 22px; height: 22px; background: rgba(239,68,68,0.85); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
    .gallery-item:hover .gallery-del { opacity: 1; }
    .divider { height: 1px; background: var(--nav-border); margin: 1rem 0; }
    /* Auth loader */
    #authLoader { position: fixed; inset: 0; z-index: 999; background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 40%, #1e40af 70%, #1e3a8a 100%); display: flex; align-items: center; justify-content: center; }
    .loader-ring { width: 48px; height: 48px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.12); border-top-color: var(--orange); animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Footer */
    .site-footer { background: linear-gradient(to right, #1e40af, #1e3a8a, #3b82f6); border-top: 2px solid var(--orange); text-align: center; padding: 1rem; font-size: 0.75rem; color: rgba(255,255,255,0.55); position: relative; z-index: 1; margin-top: auto; }
    .site-footer a { color: var(--orange); text-decoration: none; font-weight: 600; }
    html { height: 100%; }
    body { min-height: 100vh; display: flex; flex-direction: column; }
    .main-wrap { flex: 1; }
  </style>
</head>
<body>
  <div id="authLoader"><div class="loader-ring"></div></div>
  <div id="toastContainer"></div>

  <nav class="site-nav">
    <div class="nav-inner">
      <div class="nav-brand">
        <img src="/TTPOA/images/ttpoa-logo.png" alt="TTPOA" class="nav-logo" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div style="display:none;width:40px;height:40px;border-radius:0.625rem;background:linear-gradient(135deg,#f97316,#3b82f6);align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(249,115,22,0.3);flex-shrink:0">
          <svg viewBox="0 0 24 24" style="width:20px;height:20px;stroke:white;fill:none"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0v6"/></svg>
        </div>
        <div class="nav-brand-text">
          <span class="nav-brand-title">TTPOA Admin</span>
          <span class="nav-brand-sub">Training &amp; Placement Officers Association</span>
        </div>
      </div>
      <div class="nav-right">
        <span class="nav-user">Logged in as: <strong id="adminName">admin</strong></span>
        <a href="http://localhost:4321/TTPOA/" target="_blank" class="btn-nav-link btn-visit">View Website</a>
        <button onclick="logout()" class="btn-nav-link btn-logout">Logout</button>
      </div>
    </div>
  </nav>

  <main class="main-wrap">
    <div class="tab-bar">
      <button class="tab-btn active" id="tab-ticker" onclick="switchTab('ticker')">News Ticker</button>
      <button class="tab-btn inactive" id="tab-events" onclick="switchTab('events')">Events</button>
      <button class="tab-btn inactive" id="tab-popup" onclick="switchTab('popup')">Landing Popup</button>
      <button class="tab-btn inactive" id="tab-settings" onclick="switchTab('settings')">Settings</button>
    </div>

    <!-- NEWS TICKER PANEL -->
    <div id="panel-ticker">
      <div class="section-head">
        <div>
          <div class="section-title">News Ticker Items</div>
          <div class="section-sub">These scroll in the ticker bar at the top of every page</div>
        </div>
        <button class="btn-primary" onclick="openTickerModal()">+ Add Item</button>
      </div>
      <div id="tickerList" style="display:flex;flex-direction:column;gap:0.75rem">
        <div class="g-card g-card-p"><div class="empty-state"><p>Loading...</p></div></div>
      </div>
    </div>

    <!-- EVENTS PANEL -->
    <div id="panel-events" style="display:none">
      <div class="section-head">
        <div>
          <div class="section-title">Events Management</div>
          <div class="section-sub">Upcoming, ongoing and past events &mdash; auto-transitions based on date</div>
        </div>
        <button class="btn-primary" onclick="openEventModal()">+ Add Event</button>
      </div>
      <div id="eventsList" style="display:flex;flex-direction:column;gap:0.875rem">
        <div class="g-card g-card-p"><div class="empty-state"><p>Loading...</p></div></div>
      </div>
    </div>

    <!-- POPUP PANEL -->
    <div id="panel-popup" style="display:none">
      <div class="section-head">
        <div>
          <div class="section-title">Landing Page Popup</div>
          <div class="section-sub">Control the announcement popup shown to visitors on the homepage</div>
        </div>
        <button class="btn-primary" onclick="openPopupModal()">+ Add Popup</button>
      </div>
      <div id="popupList" style="display:flex;flex-direction:column;gap:0.75rem">
        <div class="g-card g-card-p"><div class="empty-state"><p>Loading...</p></div></div>
      </div>
    </div>

    <!-- SETTINGS PANEL -->
    <div id="panel-settings" style="display:none">
      <div class="section-title" style="margin-bottom:1.5rem">Settings</div>
      <div class="g-card g-card-p" style="max-width:440px">
        <div style="font-size:1rem;font-weight:700;color:white;margin-bottom:1.25rem;padding-bottom:0.875rem;border-bottom:1px solid var(--nav-border)">Change Password</div>
        <form id="changePasswordForm">
          <div class="f-group">
            <label class="f-label" for="currentPassword">Current Password</label>
            <input type="password" id="currentPassword" class="f-input" required>
          </div>
          <div class="f-group">
            <label class="f-label" for="newPassword">New Password</label>
            <input type="password" id="newPassword" class="f-input" required minlength="6">
          </div>
          <button type="submit" class="btn-primary" style="margin-top:0.5rem">Update Password</button>
        </form>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    &copy; 2026 TTPOA Admin Panel &mdash; <a href="http://localhost:4321/TTPOA/" target="_blank">Back to Website</a>
  </footer>

  <!-- TICKER MODAL -->
  <div id="tickerModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeModal('tickerModal')">
    <div class="modal-box" style="max-width:520px">
      <div class="modal-title">
        <span id="tickerModalTitle">Add News Ticker Item</span>
        <button class="modal-close" onclick="closeModal('tickerModal')">&#x2715;</button>
      </div>
      <form id="tickerForm">
        <input type="hidden" id="tickerEditId">
        <div class="f-group">
          <label class="f-label" for="tickerText">Ticker Text *</label>
          <textarea id="tickerText" class="f-textarea" rows="3" required></textarea>
        </div>
        <div class="f-group">
          <label class="f-label" for="tickerLink">Link URL</label>
          <input type="text" id="tickerLink" class="f-input" placeholder="/TTPOA/services/">
        </div>
        <div class="f-row">
          <div>
            <label class="f-label" for="tickerOrder">Sort Order</label>
            <input type="number" id="tickerOrder" class="f-input" value="0">
          </div>
          <div>
            <label class="f-label" for="tickerActive">Status</label>
            <select id="tickerActive" class="f-select">
              <option value="1">Active</option>
              <option value="0">Inactive</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeModal('tickerModal')">Cancel</button>
          <button type="submit" class="btn-primary">Save Item</button>
        </div>
      </form>
    </div>
  </div>

  <!-- EVENT MODAL -->
  <div id="eventModal" class="modal-overlay" style="display:none" onclick="if(this===event.currentTarget&&event.target===this)closeModal('eventModal')">
    <div class="modal-box" style="max-width:660px">
      <div class="modal-title">
        <span id="eventModalTitle">Add Event</span>
        <button class="modal-close" onclick="closeModal('eventModal')">&#x2715;</button>
      </div>
      <form id="eventForm" enctype="multipart/form-data">
        <input type="hidden" id="eventEditId">
        <div class="f-group">
          <label class="f-label" for="eventName">Event Name *</label>
          <input type="text" id="eventName" class="f-input" required>
        </div>
        <div class="f-row">
          <div>
            <label class="f-label" for="eventDate">Event Date *</label>
            <input type="date" id="eventDate" class="f-input" required>
          </div>
          <div>
            <label class="f-label" for="eventEndDate">End Date (multi-day)</label>
            <input type="date" id="eventEndDate" class="f-input">
          </div>
        </div>
        <div class="f-group">
          <label class="f-label" for="eventVenue">Venue</label>
          <input type="text" id="eventVenue" class="f-input" placeholder="City / Hall / Online">
        </div>
        <div class="f-group">
          <label class="f-label" for="eventDescription">Description <span id="eventDescWordCount" style="font-weight:400;color:var(--text-muted);font-size:0.75rem">(0/250 chars)</span></label>
          <textarea id="eventDescription" class="f-textarea" rows="3" maxlength="250" oninput="enforceCharLimit(this,'eventDescWordCount',250)"></textarea>
        </div>
        <div class="f-group">
          <label class="f-label" for="eventCoverImage">Cover Image</label>
          <input type="file" id="eventCoverImage" class="f-file" accept="image/*">
          <div id="eventCoverPreview" style="display:none"><img id="eventCoverImg" class="img-preview" alt=""></div>
        </div>
        <div class="f-row">
          <div>
            <label class="f-label" for="eventRegistration">Registration</label>
            <select id="eventRegistration" class="f-select" onchange="togglePaidField()">
              <option value="0">No Registration</option>
              <option value="1">Registration Open</option>
            </select>
          </div>
          <div>
            <label class="f-label" for="eventStatus">Status</label>
            <select id="eventStatus" class="f-select">
              <option value="upcoming">Upcoming</option>
              <option value="ongoing">Ongoing</option>
              <option value="recent">Recent / Past</option>
            </select>
          </div>
        </div>
        <div class="f-row" id="paidPriceRow" style="display:none">
          <div id="paidSection">
            <label class="f-label" for="eventPaid">Paid / Free</label>
            <select id="eventPaid" class="f-select" onchange="togglePriceField()">
              <option value="0">Free</option>
              <option value="1">Paid</option>
            </select>
          </div>
          <div id="priceSection" style="display:none">
            <label class="f-label" for="eventPrice">Price (INR)</label>
            <input type="number" id="eventPrice" class="f-input" min="0" value="0">
          </div>
        </div>
        <div class="f-group" id="regLinkSection" style="display:none">
          <label class="f-label" for="eventRegLink">Registration Link</label>
          <input type="url" id="eventRegLink" class="f-input" placeholder="https://...">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeModal('eventModal')">Cancel</button>
          <button type="submit" class="btn-primary">Save Event</button>
        </div>
      </form>
    </div>
  </div>

  <!-- GALLERY MODAL -->
  <div id="galleryModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeModal('galleryModal')">
    <div class="modal-box" style="max-width:560px">
      <div class="modal-title">
        <span>Event Gallery</span>
        <button class="modal-close" onclick="closeModal('galleryModal')">&#x2715;</button>
      </div>
      <div id="galleryImages" class="gallery-grid" style="min-height:60px;margin-bottom:1rem"></div>
      <div class="divider"></div>
      <div>
        <label class="f-label">Upload Photos</label>
        <input type="file" id="galleryUpload" class="f-file" accept="image/*" multiple>
        <button onclick="uploadGalleryImages()" class="btn-primary" style="margin-top:0.75rem">Upload Photos</button>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeModal('galleryModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- POPUP MODAL -->
  <div id="popupFormModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeModal('popupFormModal')">
    <div class="modal-box" style="max-width:520px">
      <div class="modal-title">
        <span id="popupModalTitle">Add Landing Page Popup</span>
        <button class="modal-close" onclick="closeModal('popupFormModal')">&#x2715;</button>
      </div>
      <form id="popupForm" enctype="multipart/form-data">
        <input type="hidden" id="popupEditId">
        <div class="f-group">
          <label class="f-label" for="popupEventName">Popup Title *</label>
          <input type="text" id="popupEventName" class="f-input" required>
        </div>
        <div class="f-group">
          <label class="f-label" for="popupDescription">Description</label>
          <textarea id="popupDescription" class="f-textarea" rows="3"></textarea>
        </div>
        <div class="f-group">
          <label class="f-label" for="popupImage">Popup Image</label>
          <input type="file" id="popupImage" class="f-file" accept="image/*">
          <div id="popupImagePreview" style="display:none"><img id="popupPreviewImg" class="img-preview" alt=""></div>
        </div>
        <div class="f-group">
          <label class="f-label" for="popupLayout">Layout</label>
          <select id="popupLayout" class="f-select">
            <option value="center">Center Modal</option>
            <option value="fullscreen">Fullscreen Overlay</option>
            <option value="bottom-right">Bottom Right</option>
          </select>
        </div>
        <div class="f-row">
          <div>
            <label class="f-label" for="popupBtnText">Button Text</label>
            <input type="text" id="popupBtnText" class="f-input" value="Learn More">
          </div>
          <div>
            <label class="f-label" for="popupBtnLink">Button Link</label>
            <input type="text" id="popupBtnLink" class="f-input" placeholder="/TTPOA/events/">
          </div>
        </div>
        <div class="f-group" style="display:flex;align-items:center;gap:0.75rem">
          <input type="checkbox" id="popupActive" class="f-checkbox">
          <label for="popupActive" style="font-size:0.875rem;color:rgba(255,255,255,0.80);cursor:pointer;text-transform:none;letter-spacing:0">Set as Active (shown on landing page)</label>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeModal('popupFormModal')">Cancel</button>
          <button type="submit" class="btn-primary">Save Popup</button>
        </div>
      </form>
    </div>
  </div>

<script>
const API = '';
let currentGalleryEventId = null;

function showToast(message, type = 'success') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast toast-' + type;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, 3000);
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function openModal(id) { document.getElementById(id).style.display = 'flex'; }

async function apiFetch(url, options = {}) {
  const res = await fetch(API + url, { credentials: 'include', ...options });
  if (res.status === 401) { window.location.href = '/ttpoa/admin/login'; return null; }
  return res;
}

function switchTab(tab) {
  ['ticker', 'events', 'popup', 'settings'].forEach(t => {
    document.getElementById('panel-' + t).style.display = t === tab ? '' : 'none';
    document.getElementById('tab-' + t).className = 'tab-btn ' + (t === tab ? 'active' : 'inactive');
  });
}

// NEWS TICKER
async function loadTicker() {
  const res = await apiFetch('/api/admin/news-ticker');
  if (!res) return;
  const items = await res.json();
  const container = document.getElementById('tickerList');
  if (items.length === 0) {
    container.innerHTML = '<div class="g-card g-card-p"><div class="empty-state"><p>No ticker items yet. Click &ldquo;+ Add Item&rdquo; to create one.</p></div></div>';
    return;
  }
  container.innerHTML = items.map(item => `
    <div class="g-card g-card-row">
      <span class="${item.active ? 'dot-active' : 'dot-inactive'}"></span>
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.25rem">
          <span style="font-size:0.7rem;color:var(--text-muted)">Order ${item.sort_order}</span>
          <span class="badge ${item.active ? 'badge-active' : 'badge-inactive'}">${item.active ? 'Active' : 'Inactive'}</span>
        </div>
        <p style="font-size:0.875rem;color:white;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(item.text)}</p>
        ${item.link ? '<p style="font-size:0.75rem;color:var(--text-muted);margin-top:0.125rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + escapeHtml(item.link) + '</p>' : ''}
      </div>
      <div style="display:flex;gap:0.5rem;flex-shrink:0">
        <button onclick='editTicker(${JSON.stringify(item).replace(/'/g, "&#39;")})' class="btn-edit">Edit</button>
        <button onclick="deleteTicker(${item.id})" class="btn-delete">Delete</button>
      </div>
    </div>
  `).join('');
}

function openTickerModal(item = null) {
  document.getElementById('tickerModalTitle').textContent = item ? 'Edit Ticker Item' : 'Add News Ticker Item';
  document.getElementById('tickerEditId').value = item?.id || '';
  document.getElementById('tickerText').value = item?.text || '';
  document.getElementById('tickerLink').value = item?.link || '';
  document.getElementById('tickerOrder').value = item?.sort_order ?? 0;
  document.getElementById('tickerActive').value = item?.active ?? 1;
  openModal('tickerModal');
}
function editTicker(item) { openTickerModal(item); }

document.getElementById('tickerForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('tickerEditId').value;
  const data = {
    text: document.getElementById('tickerText').value,
    link: document.getElementById('tickerLink').value,
    sort_order: parseInt(document.getElementById('tickerOrder').value),
    active: parseInt(document.getElementById('tickerActive').value)
  };
  const url = id ? '/api/admin/news-ticker/' + id : '/api/admin/news-ticker';
  await apiFetch(url, { method: id ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
  closeModal('tickerModal');
  showToast(id ? 'Ticker item updated!' : 'Ticker item added!');
  loadTicker();
});

async function deleteTicker(id) {
  if (!confirm('Delete this ticker item?')) return;
  await apiFetch('/api/admin/news-ticker/' + id, { method: 'DELETE' });
  showToast('Ticker item deleted!');
  loadTicker();
}

// EVENTS
async function loadEvents() {
  const res = await apiFetch('/api/admin/events');
  if (!res) return;
  const events = await res.json();
  const container = document.getElementById('eventsList');
  if (events.length === 0) {
    container.innerHTML = '<div class="g-card g-card-p"><div class="empty-state"><p>No events yet. Click &ldquo;+ Add Event&rdquo; to create one.</p></div></div>';
    return;
  }
  const badgeMap = { upcoming: 'badge-upcoming', ongoing: 'badge-ongoing', recent: 'badge-recent' };
  container.innerHTML = events.map(ev => `
    <div class="g-card g-card-p">
      <div style="display:flex;flex-direction:column;gap:0.875rem">
        <div style="display:flex;flex-wrap:wrap;gap:0.875rem">
          ${ev.cover_image ? '<img src="' + ev.cover_image + '" style="width:160px;height:110px;object-fit:cover;border-radius:0.75rem;border:1px solid var(--card-border);flex-shrink:0" alt="">' : '<div style="width:160px;height:110px;border-radius:0.75rem;border:1px solid var(--card-border);background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:0.75rem;flex-shrink:0">No Cover</div>'}
          <div style="flex:1;min-width:200px">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:0.5rem;margin-bottom:0.5rem">
              <h3 style="font-size:1.0625rem;font-weight:700;color:white">${escapeHtml(ev.name)}</h3>
              <span class="badge ${badgeMap[ev.status] || 'badge-recent'}">${ev.status.toUpperCase()}</span>
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:0.625rem;font-size:0.8rem;color:var(--text-muted);margin-bottom:0.5rem">
              <span>Date: ${ev.date}${ev.end_date ? ' to ' + ev.end_date : ''}</span>
              ${ev.venue ? '<span>Venue: ' + escapeHtml(ev.venue) + '</span>' : ''}
              ${ev.registration_open ? '<span style="color:#86efac">Registration Open</span>' : ''}
              ${ev.is_paid ? '<span style="color:#fdba74">Paid - INR ' + ev.price + '</span>' : ev.registration_open ? '<span style="color:#93c5fd">Free</span>' : ''}
            </div>
            ${ev.description ? '<p style="font-size:0.8125rem;color:var(--text-muted);-webkit-line-clamp:2;display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden">' + escapeHtml(ev.description) + '</p>' : ''}
          </div>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:0.5rem;padding-top:0.625rem;border-top:1px solid var(--nav-border)">
          <button onclick='editEvent(${JSON.stringify({...ev, gallery: undefined}).replace(/'/g, "&#39;")})' class="btn-edit">Edit</button>
          <button onclick="openGallery(${ev.id})" class="btn-gallery">Gallery (${ev.gallery?.length || 0})</button>
          <button onclick="deleteEvent(${ev.id})" class="btn-delete">Delete</button>
        </div>
      </div>
    </div>
  `).join('');
}

function togglePaidField() {
  const reg = document.getElementById('eventRegistration').value;
  document.getElementById('paidPriceRow').style.display = reg === '1' ? '' : 'none';
  document.getElementById('regLinkSection').style.display = reg === '1' ? '' : 'none';
  if (reg === '0') document.getElementById('priceSection').style.display = 'none';
}
function togglePriceField() {
  document.getElementById('priceSection').style.display = document.getElementById('eventPaid').value === '1' ? '' : 'none';
}

function openEventModal(event = null) {
  document.getElementById('eventModalTitle').textContent = event ? 'Edit Event' : 'Add Event';
  document.getElementById('eventEditId').value = event?.id || '';
  document.getElementById('eventName').value = event?.name || '';
  document.getElementById('eventDate').value = event?.date || '';
  document.getElementById('eventEndDate').value = event?.end_date || '';
  document.getElementById('eventVenue').value = event?.venue || '';
  document.getElementById('eventDescription').value = event?.description || '';
  enforceCharLimit(document.getElementById('eventDescription'), 'eventDescWordCount', 250);
  document.getElementById('eventRegistration').value = event?.registration_open ?? 0;
  document.getElementById('eventPaid').value = event?.is_paid ?? 0;
  document.getElementById('eventPrice').value = event?.price ?? 0;
  document.getElementById('eventRegLink').value = event?.registration_link || '';
  document.getElementById('eventStatus').value = event?.status || 'upcoming';
  document.getElementById('eventCoverImage').value = '';
  if (event?.cover_image) {
    document.getElementById('eventCoverPreview').style.display = '';
    document.getElementById('eventCoverImg').src = event.cover_image;
  } else {
    document.getElementById('eventCoverPreview').style.display = 'none';
  }
  togglePaidField(); togglePriceField();
  openModal('eventModal');
}
function editEvent(event) { openEventModal(event); }

document.getElementById('eventForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('eventEditId').value;
  const fd = new FormData();
  fd.append('name', document.getElementById('eventName').value);
  fd.append('date', document.getElementById('eventDate').value);
  fd.append('end_date', document.getElementById('eventEndDate').value);
  fd.append('venue', document.getElementById('eventVenue').value);
  fd.append('description', document.getElementById('eventDescription').value.trim().substring(0, 250));
  fd.append('registration_open', document.getElementById('eventRegistration').value);
  fd.append('is_paid', document.getElementById('eventPaid').value);
  fd.append('price', document.getElementById('eventPrice').value);
  fd.append('registration_link', document.getElementById('eventRegLink').value);
  fd.append('status', document.getElementById('eventStatus').value);
  const file = document.getElementById('eventCoverImage').files[0];
  if (file) fd.append('cover_image', file);
  await apiFetch(id ? '/api/admin/events/' + id : '/api/admin/events', { method: id ? 'PUT' : 'POST', body: fd });
  closeModal('eventModal');
  showToast(id ? 'Event updated!' : 'Event created!');
  loadEvents();
});

async function deleteEvent(id) {
  if (!confirm('Delete this event and all its gallery images?')) return;
  await apiFetch('/api/admin/events/' + id, { method: 'DELETE' });
  showToast('Event deleted!');
  loadEvents();
}

// GALLERY
async function openGallery(eventId) {
  currentGalleryEventId = eventId;
  const res = await apiFetch('/api/admin/events');
  if (!res) return;
  const events = await res.json();
  const event = events.find(e => e.id === eventId);
  if (!event) return;
  const container = document.getElementById('galleryImages');
  if (!event.gallery || event.gallery.length === 0) {
    container.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:var(--text-muted);font-size:0.875rem;padding:1.5rem 0">No gallery images yet.</p>';
  } else {
    container.innerHTML = event.gallery.map(img => `
      <div class="gallery-item">
        <img src="${img.image_path}" alt="">
        <button class="gallery-del" onclick="deleteGalleryImage(${img.id})">&#x2715;</button>
      </div>
    `).join('');
  }
  document.getElementById('galleryUpload').value = '';
  openModal('galleryModal');
}

async function uploadGalleryImages() {
  const files = document.getElementById('galleryUpload').files;
  if (!files.length) return showToast('Select images to upload first', 'error');
  const fd = new FormData();
  for (const f of files) fd.append('images', f);
  await apiFetch('/api/admin/events/' + currentGalleryEventId + '/gallery', { method: 'POST', body: fd });
  showToast('Images uploaded!');
  openGallery(currentGalleryEventId);
  loadEvents();
}

async function deleteGalleryImage(imageId) {
  if (!confirm('Delete this image?')) return;
  await apiFetch('/api/admin/events/gallery/' + imageId, { method: 'DELETE' });
  showToast('Image deleted!');
  openGallery(currentGalleryEventId);
  loadEvents();
}

// POPUPS
async function loadPopups() {
  const res = await apiFetch('/api/admin/popup');
  if (!res) return;
  const popups = await res.json();
  const container = document.getElementById('popupList');
  if (popups.length === 0) {
    container.innerHTML = '<div class="g-card g-card-p"><div class="empty-state"><p>No popups configured. Click &ldquo;+ Add Popup&rdquo; to create one.</p></div></div>';
    return;
  }
  container.innerHTML = popups.map(p => `
    <div class="g-card g-card-row">
      ${p.image ? '<img src="' + p.image + '" style="width:80px;height:60px;object-fit:cover;border-radius:0.5rem;border:1px solid var(--card-border);flex-shrink:0" alt="">' : '<div style="width:80px;height:60px;border-radius:0.5rem;border:1px solid var(--card-border);background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;font-size:0.75rem;color:var(--text-muted);flex-shrink:0">No img</div>'}
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;flex-wrap:wrap;gap:0.375rem;margin-bottom:0.25rem">
          <span style="font-size:0.9rem;font-weight:700;color:white">${escapeHtml(p.event_name)}</span>
          <span class="badge ${p.active ? 'badge-active' : 'badge-inactive'}">${p.active ? 'ACTIVE' : 'INACTIVE'}</span>
          <span class="badge badge-orange">${p.layout}</span>
        </div>
        <p style="font-size:0.8rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(p.description || 'No description')}</p>
      </div>
      <div style="display:flex;gap:0.5rem;flex-shrink:0">
        <button onclick="togglePopup(${p.id})" class="${p.active ? 'btn-deactivate' : 'btn-activate'}">${p.active ? 'Deactivate' : 'Activate'}</button>
        <button onclick='editPopup(${JSON.stringify(p).replace(/'/g, "&#39;")})' class="btn-edit">Edit</button>
        <button onclick="deletePopup(${p.id})" class="btn-delete">Delete</button>
      </div>
    </div>
  `).join('');
}

function openPopupModal(popup = null) {
  document.getElementById('popupModalTitle').textContent = popup ? 'Edit Popup' : 'Add Landing Page Popup';
  document.getElementById('popupEditId').value = popup?.id || '';
  document.getElementById('popupEventName').value = popup?.event_name || '';
  document.getElementById('popupDescription').value = popup?.description || '';
  document.getElementById('popupLayout').value = popup?.layout || 'center';
  document.getElementById('popupBtnText').value = popup?.button_text || 'Learn More';
  document.getElementById('popupBtnLink').value = popup?.button_link || '';
  document.getElementById('popupActive').checked = popup?.active ? true : false;
  document.getElementById('popupImage').value = '';
  if (popup?.image) {
    document.getElementById('popupImagePreview').style.display = '';
    document.getElementById('popupPreviewImg').src = popup.image;
  } else {
    document.getElementById('popupImagePreview').style.display = 'none';
  }
  openModal('popupFormModal');
}
function editPopup(popup) { openPopupModal(popup); }

document.getElementById('popupForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('popupEditId').value;
  const fd = new FormData();
  fd.append('event_name', document.getElementById('popupEventName').value);
  fd.append('description', document.getElementById('popupDescription').value);
  fd.append('layout', document.getElementById('popupLayout').value);
  fd.append('button_text', document.getElementById('popupBtnText').value);
  fd.append('button_link', document.getElementById('popupBtnLink').value);
  fd.append('active', document.getElementById('popupActive').checked ? 1 : 0);
  const file = document.getElementById('popupImage').files[0];
  if (file) fd.append('image', file);
  await apiFetch(id ? '/api/admin/popup/' + id : '/api/admin/popup', { method: id ? 'PUT' : 'POST', body: fd });
  closeModal('popupFormModal');
  showToast(id ? 'Popup updated!' : 'Popup created!');
  loadPopups();
});

async function togglePopup(id) {
  await apiFetch('/api/admin/popup/' + id + '/toggle', { method: 'PUT' });
  showToast('Popup status toggled!');
  loadPopups();
}

async function deletePopup(id) {
  if (!confirm('Delete this popup?')) return;
  await apiFetch('/api/admin/popup/' + id, { method: 'DELETE' });
  showToast('Popup deleted!');
  loadPopups();
}

// SETTINGS
document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const res = await apiFetch('/api/auth/change-password', {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ currentPassword: document.getElementById('currentPassword').value, newPassword: document.getElementById('newPassword').value })
  });
  const data = await res.json();
  if (res.ok) { showToast('Password changed successfully!'); e.target.reset(); }
  else showToast(data.error || 'Failed to change password', 'error');
});

// AUTH
async function logout() {
  await apiFetch('/api/auth/logout', { method: 'POST' });
  window.location.href = '/ttpoa/admin/login';
}

// HELPERS
function escapeHtml(text) {
  const d = document.createElement('div'); d.textContent = text; return d.innerHTML;
}

function enforceCharLimit(textarea, counterId, maxChars) {
  if (textarea.value.length > maxChars) textarea.value = textarea.value.substring(0, maxChars);
  const current = textarea.value.length;
  const counter = document.getElementById(counterId);
  if (counter) {
    counter.textContent = `(${current}/${maxChars} chars)`;
    counter.style.color = current >= maxChars ? 'var(--orange)' : 'var(--text-muted)';
  }
}

// INIT
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const r = await fetch('/api/auth/check', { credentials: 'include' });
    const d = await r.json();
    if (!d.authenticated) { location.href = '/ttpoa/admin/login'; return; }
    document.getElementById('adminName').textContent = d.username || 'admin';
    const el = document.getElementById('authLoader');
    if (el) el.remove();
  } catch { location.href = '/ttpoa/admin/login'; return; }
  loadTicker();
  loadEvents();
  loadPopups();
});
</script>
</body>
</html>